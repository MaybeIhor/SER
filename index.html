<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Survey</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #111;
    --surface: #1c1c1c;
    --border: #333;
    --border-hover: #666;
    --text: #e8e8e8;
    --muted: #999;
    --happy-color: #6dbd85;
    --angry-color: #d96060;
    --fear-color:  #b080e8;
    --sad-color:   #5ba8e0;
  }

  body {
    font-family: 'IBM Plex Mono', monospace;
    background: var(--bg);
    color: var(--text);
    padding: 40px 20px 80px;
    min-height: 100vh;
  }

  .items {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-width: 720px;
    margin: 0 auto;
  }

  .item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .item-header {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  audio {
    width: 100%;
    height: 36px;
    outline: none;
    filter: invert(1) hue-rotate(180deg);
  }

  .sliders {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .slider-row {
    display: grid;
    grid-template-columns: 80px 1fr 36px;
    align-items: center;
    gap: 12px;
  }

  .slider-label {
    display: flex;
    align-items: center;
    gap: 7px;
    font-size: 11px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    font-weight: 500;
    color: var(--muted);
  }

  .slider-label svg { opacity: 0.7; flex-shrink: 0; }

  .slider-label.happy { color: var(--happy-color); }
  .slider-label.angry { color: var(--angry-color); }
  .slider-label.fear  { color: var(--fear-color);  }
  .slider-label.sad   { color: var(--sad-color);   }

  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 3px;
    border-radius: 2px;
    background: var(--border);
    outline: none;
    cursor: pointer;
  }

  input[type="range"].happy { accent-color: var(--happy-color); }
  input[type="range"].angry { accent-color: var(--angry-color); }
  input[type="range"].fear  { accent-color: var(--fear-color);  }
  input[type="range"].sad   { accent-color: var(--sad-color);   }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    cursor: pointer;
  }

  input[type="range"].happy::-webkit-slider-thumb { background: var(--happy-color); }
  input[type="range"].angry::-webkit-slider-thumb { background: var(--angry-color); }
  input[type="range"].fear::-webkit-slider-thumb  { background: var(--fear-color);  }
  input[type="range"].sad::-webkit-slider-thumb   { background: var(--sad-color);   }

  input[type="range"]::-moz-range-thumb {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
  }

  input[type="range"].happy::-moz-range-thumb { background: var(--happy-color); }
  input[type="range"].angry::-moz-range-thumb { background: var(--angry-color); }
  input[type="range"].fear::-moz-range-thumb  { background: var(--fear-color);  }
  input[type="range"].sad::-moz-range-thumb   { background: var(--sad-color);   }

  .slider-value {
    font-size: 11px;
    color: var(--muted);
    text-align: right;
    min-width: 36px;
  }

  .age-block {
    max-width: 720px;
    margin: 20px auto 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 16px;
  }

  .age-label {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  .age-options {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }

  .age-option { position: relative; }

  .age-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .age-option label {
    display: block;
    text-align: center;
    padding: 10px 4px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 12px;
    letter-spacing: 0.06em;
    cursor: pointer;
    transition: border-color 0.15s, color 0.15s, background 0.15s;
    user-select: none;
    text-transform: uppercase;
    font-weight: 500;
    color: var(--muted);
  }

  .age-option label:hover { border-color: var(--border-hover); color: var(--text); }

  .age-option input:checked + label {
    background: #252525;
    border-color: var(--text);
    color: var(--text);
  }

  .footer {
    max-width: 720px;
    margin: 24px auto 0;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .submit-btn {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 12px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-weight: 500;
    padding: 12px 32px;
    background: var(--text);
    color: var(--bg);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: opacity 0.15s;
  }

  .submit-btn:hover:not(:disabled) { opacity: 0.8; }
  .submit-btn:disabled { opacity: 0.2; cursor: not-allowed; }

  .status { font-size: 11px; color: var(--muted); }

  .progress {
    font-size: 11px;
    color: var(--muted);
    text-align: right;
    max-width: 720px;
    margin: 0 auto 20px;
  }

  #toast {
    display: none;
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--text);
    color: var(--bg);
    padding: 12px 24px;
    border-radius: 4px;
    font-size: 12px;
    letter-spacing: 0.05em;
    z-index: 100;
  }
</style>
</head>
<body>

<div id="progress" class="progress"></div>
<div class="items" id="items"></div>

<div class="age-block">
  <div class="age-label">Your age group</div>
  <div class="age-options">
    <div class="age-option">
      <input type="radio" name="age" id="age1" value="0-25">
      <label for="age1">0 – 25</label>
    </div>
    <div class="age-option">
      <input type="radio" name="age" id="age2" value="25-50">
      <label for="age2">25 – 50</label>
    </div>
    <div class="age-option">
      <input type="radio" name="age" id="age3" value="50+">
      <label for="age3">50+</label>
    </div>
  </div>
</div>

<div class="footer">
  <button class="submit-btn" id="submitBtn" disabled>Submit</button>
  <span class="status" id="status">Complete all samples and select age group.</span>
</div>
<div id="toast"></div>

<script>
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyH4Qu0y0efs72XsA2WgTmBmfvt9RveRTW-uQ2oDGmp8Rtgp0SimKiOHuDlWJ9yOkiw/exec";
  const BASE_URL = "https://maybeihor.github.io/SER/test/";
  const EMOTIONS = ["happy", "angry", "fear", "sad"];

  let ageSelected = false;
  let allSlidersTouched = false;
  const touchedItems = new Set();
  let totalFiles = 0;

  document.querySelectorAll('input[name="age"]').forEach(r => {
    r.addEventListener("change", () => {
      ageSelected = true;
      checkSubmit();
    });
  });

  function checkSubmit() {
    const ready = ageSelected && touchedItems.size === totalFiles;
    document.getElementById("submitBtn").disabled = !ready;
    if (!ready) {
      const missing = totalFiles - touchedItems.size;
      if (missing > 0) {
        document.getElementById("status").textContent = `${missing} sample${missing > 1 ? "s" : ""} remaining.`;
      } else {
        document.getElementById("status").textContent = "Your age.";
      }
    } else {
      document.getElementById("status").textContent = "Ready to submit.";
    }
  }

  async function loadFiles() {
    const res = await fetch("files.json");
    return await res.json();
  }

  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function buildUI(files) {
    totalFiles = files.length;
    const container = document.getElementById("items");
    const progressEl = document.getElementById("progress");
    progressEl.textContent = `0 / ${files.length} samples`;

    files.forEach((filename, i) => {
      const item = document.createElement("div");
      item.className = "item";

      const header = document.createElement("div");
      header.className = "item-header";
      header.textContent = `${String(i + 1).padStart(2, "0")} / ${files.length}`;

      const audio = document.createElement("audio");
      audio.controls = true;
      audio.preload = "none";
      audio.src = BASE_URL + filename;

      const sliders = document.createElement("div");
      sliders.className = "sliders";

      EMOTIONS.forEach(emotion => {
        const row = document.createElement("div");
        row.className = "slider-row";

        const labelEl = document.createElement("div");
        labelEl.className = `slider-label ${emotion}`;
        label.textContent = emotion;

        const range = document.createElement("input");
        range.type = "range";
        range.className = emotion;
        range.min = 0;
        range.max = 100;
        range.value = 0;
        range.dataset.file = filename;
        range.dataset.emotion = emotion;

        const valueEl = document.createElement("span");
        valueEl.className = "slider-value";
        valueEl.textContent = "0.00";

        range.addEventListener("input", () => {
          valueEl.textContent = (range.value / 100).toFixed(2);
          touchedItems.add(filename);
          progressEl.textContent = `${touchedItems.size} / ${files.length} samples`;
          checkSubmit();
        });

        row.appendChild(labelEl);
        row.appendChild(range);
        row.appendChild(valueEl);
        sliders.appendChild(row);
      });

      item.appendChild(header);
      item.appendChild(audio);
      item.appendChild(sliders);
      container.appendChild(item);
    });

    document.getElementById("submitBtn").addEventListener("click", async () => {
      const btn = document.getElementById("submitBtn");
      const statusEl = document.getElementById("status");
      btn.disabled = true;
      statusEl.textContent = "Saved.";

      const ageGroup = document.querySelector('input[name="age"]:checked').value;
      const d = new Date();
      const timestamp = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
      const rows = [];

      files.forEach(filename => {
        const row = { filename, age_group: ageGroup, timestamp };
        EMOTIONS.forEach(emotion => {
          const range = document.querySelector(`input[type="range"][data-file="${filename}"][data-emotion="${emotion}"]`);
          row[emotion] = (range.value / 100).toFixed(4);
        });
        rows.push(row);
      });

      try {
        await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(rows),
        });
        statusEl.textContent = "Submitted.";
      } catch (e) {
        btn.disabled = false;
        statusEl.textContent = "Error: " + e.message;
      }
    });
  }

  loadFiles()
    .then(files => buildUI(shuffle(files)))
    .catch(e => {
      document.getElementById("status").textContent = "Error loading files: " + e.message;
    });
</script>
</body>
</html>

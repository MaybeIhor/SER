<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Survey</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #111;
    --surface: #1c1c1c;
    --border: #333;
    --border-hover: #666;
    --text: #e8e8e8;
    --muted: #999;
    --happy-sel: #1a3320;
    --happy-border: #3a8050;
    --happy-text: #6dbd85;
    --angry-sel: #331515;
    --angry-border: #8a2525;
    --angry-text: #d96060;
    --fear-sel: #221535;
    --fear-border: #6a35a0;
    --fear-text: #b080e8;
    --sad-sel: #0f1f33;
    --sad-border: #255a96;
    --sad-text: #5ba8e0;
  }

  body {
    font-family: 'IBM Plex Mono', monospace;
    background: var(--bg);
    color: var(--text);
    padding: 40px 20px 80px;
    min-height: 100vh;
  }

  .items {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-width: 720px;
    margin: 0 auto;
  }

  .item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .item-header {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  audio {
    width: 100%;
    height: 36px;
    outline: none;
    filter: invert(1) hue-rotate(180deg);
  }

  .options {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
  }

  .option { position: relative; }

  .option input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .option label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 7px;
    padding: 12px 4px 10px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 11px;
    letter-spacing: 0.06em;
    cursor: pointer;
    transition: border-color 0.15s, color 0.15s, background 0.15s;
    user-select: none;
    text-transform: uppercase;
    font-weight: 500;
    color: var(--muted);
  }

  .option label svg {
    display: block;
    transition: opacity 0.15s;
    opacity: 0.7;
  }

  .option label:hover { border-color: var(--border-hover); color: var(--text); }
  .option label:hover svg { opacity: 1; }

  .option input[value="happy"]:checked + label { background: var(--happy-sel); border-color: var(--happy-border); color: var(--happy-text); }
  .option input[value="angry"]:checked + label { background: var(--angry-sel); border-color: var(--angry-border); color: var(--angry-text); }
  .option input[value="fear"]:checked  + label { background: var(--fear-sel);  border-color: var(--fear-border);  color: var(--fear-text);  }
  .option input[value="sad"]:checked   + label { background: var(--sad-sel);   border-color: var(--sad-border);   color: var(--sad-text);   }

  .option input:checked + label svg { opacity: 1; filter: none; }

  .footer {
    max-width: 720px;
    margin: 32px auto 0;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .submit-btn {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 12px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-weight: 500;
    padding: 12px 32px;
    background: var(--text);
    color: var(--bg);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: opacity 0.15s;
  }

  .submit-btn:hover:not(:disabled) { opacity: 0.8; }
  .submit-btn:disabled { opacity: 0.2; cursor: not-allowed; }

  .status { font-size: 11px; color: var(--muted); }

  .progress {
    font-size: 11px;
    color: var(--muted);
    text-align: right;
    max-width: 720px;
    margin: 0 auto 20px;
  }

  #toast {
    display: none;
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--text);
    color: var(--bg);
    padding: 12px 24px;
    border-radius: 4px;
    font-size: 12px;
    letter-spacing: 0.05em;
    z-index: 100;
  }
</style>
</head>
<body>

<div id="progress" class="progress"></div>
<div class="items" id="items"></div>
<div class="footer">
  <button class="submit-btn" id="submitBtn" disabled>Submit</button>
  <span class="status" id="status">Answer all items to submit.</span>
</div>
<div id="toast"></div>

<script>
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw_D8hVt0exe4TOJlEUENuPVp7BODr8FcipV9qO6Zn3MryBbLkK4Rcq1PCpD3vneNtw/exec";
  const BASE_URL = "https://maybeihor.github.io/SER/test/";
  const EMOTIONS = ["happy", "angry", "fear", "sad"];

  const ICONS = {
    happy: `<svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="14" cy="14" r="11" stroke="currentColor" stroke-width="1.5"/><circle cx="10" cy="11" r="1.5" fill="currentColor"/><circle cx="18" cy="11" r="1.5" fill="currentColor"/><path d="M9 16.5c1 2.5 9 2.5 10 0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`,
    angry: `<svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="14" cy="14" r="11" stroke="currentColor" stroke-width="1.5"/><circle cx="10" cy="13" r="1.5" fill="currentColor"/><circle cx="18" cy="13" r="1.5" fill="currentColor"/><path d="M8 9.5l4 2M20 9.5l-4 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M9 19.5c1-2.5 9-2.5 10 0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`,
    fear: `<svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="14" cy="14" r="11" stroke="currentColor" stroke-width="1.5"/><ellipse cx="10" cy="12" rx="2" ry="2.5" fill="currentColor"/><ellipse cx="18" cy="12" rx="2" ry="2.5" fill="currentColor"/><ellipse cx="14" cy="19" rx="3" ry="2" stroke="currentColor" stroke-width="1.5"/><path d="M12 8.5l-.5-2M16 8.5l.5-2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`,
    sad: `<svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="14" cy="14" r="11" stroke="currentColor" stroke-width="1.5"/><circle cx="10" cy="11" r="1.5" fill="currentColor"/><circle cx="18" cy="11" r="1.5" fill="currentColor"/><path d="M9 19.5c1-2.5 9-2.5 10 0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M17.5 15.5c.3-.8 1-1.2 1.5-1" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/><circle cx="18.5" cy="17" r="1" fill="currentColor" opacity="0.5"/></svg>`
  };

  async function loadFiles() {
    const res = await fetch("files.json");
    return await res.json();
  }

  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function buildUI(files) {
    const container = document.getElementById("items");
    const progressEl = document.getElementById("progress");
    const submitBtn = document.getElementById("submitBtn");
    const statusEl = document.getElementById("status");
    const answers = {};

    files.forEach((filename, i) => {
      const item = document.createElement("div");
      item.className = "item";

      const header = document.createElement("div");
      header.className = "item-header";
      header.textContent = `${String(i + 1).padStart(2, "0")} / ${files.length}`;

      const audio = document.createElement("audio");
      audio.controls = true;
      audio.preload = "none";
      audio.src = BASE_URL + filename;

      const options = document.createElement("div");
      options.className = "options";

      EMOTIONS.forEach(emotion => {
        const wrapper = document.createElement("div");
        wrapper.className = "option";

        const input = document.createElement("input");
        input.type = "radio";
        input.name = `q_${i}`;
        input.value = emotion;
        input.id = `q_${i}_${emotion}`;

        input.addEventListener("change", () => {
          answers[filename] = emotion;
          const answered = Object.keys(answers).length;
          progressEl.textContent = `${answered} / ${files.length} answered`;
          if (answered === files.length) {
            submitBtn.disabled = false;
            statusEl.textContent = "Ready to submit.";
          }
        });

        const label = document.createElement("label");
        label.htmlFor = `q_${i}_${emotion}`;
        label.innerHTML = ICONS[emotion] + `<span>${emotion}</span>`;

        wrapper.appendChild(input);
        wrapper.appendChild(label);
        options.appendChild(wrapper);
      });

      item.appendChild(header);
      item.appendChild(audio);
      item.appendChild(options);
      container.appendChild(item);
    });

    progressEl.textContent = `0 / ${files.length} answered`;

    submitBtn.addEventListener("click", async () => {
      submitBtn.disabled = true;
      statusEl.textContent = "Saving...";
      try {
        await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(answers),
        });
        showToast("Submitted. Thank you.");
        statusEl.textContent = "Submitted.";
      } catch (e) {
        submitBtn.disabled = false;
        statusEl.textContent = "Error: " + e.message;
      }
    });
  }

  function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(() => t.style.display = "none", 3000);
  }

  loadFiles()
    .then(files => buildUI(shuffle(files)))
    .catch(e => {
      document.getElementById("status").textContent = "Error loading files: " + e.message;
    });
</script>
</body>
</html>
